# Providers Directory

This directory contains Riverpod providers that manage and expose application state and services. Providers are a core part of the application's architecture, enabling efficient state management, dependency injection, and reactive UI updates.

## `app_router_provider.dart`

This file defines the `goRouterProvider`, which is responsible for managing the application's navigation using the `go_router` package. It integrates with the authentication state to handle redirects, ensuring users are directed to the appropriate screens based on their login status.

### `goRouterProvider`

*   **Type**: `AutoDisposeProvider<GoRouter>`
*   **Purpose**: Provides the `GoRouter` instance used for navigation throughout the application.
*   **Dependencies**: Watches `authProvider` to react to authentication state changes, which in turn triggers navigation redirects.
*   **Initial Location**: Starts at `ScreenLoginValidation.routeName`.
*   **Refresh Listener**: Uses `GoRouterRefreshStream` to listen for changes in the `authProvider`'s stream, enabling automatic redirection based on authentication status.
*   **Routes**: Defines the various routes available in the application, mapping paths to specific screens (e.g., `ScreenLoginValidation`, `ScreenHome`, `ScreenProfileEdit`).
*   **Redirect Logic**:
    *   Prevents redirection while authentication is in progress (`isAuthenticating`).
    *   Redirects authenticated users from the login page to the home screen.
    *   Redirects unauthenticated users from any page (except the login page) to the login page.

### `GoRouterRefreshStream` Class

*   **Purpose**: A helper class that extends `ChangeNotifier` and implements `Listenable` to bridge a `Stream` with `GoRouter`'s `refreshListenable` property. This allows `GoRouter` to react to changes emitted by a stream (like the authentication state stream) and re-evaluate its redirection logic.

## `auth_provider.dart`

This file defines the `authProvider`, `userProfileProvider`, `userProfileImageProvider`, and `userProfileManagerProvider`. These providers collectively manage user authentication, user profile data, and related operations.

### `AuthState` Enum

*   **`unknown`**: Initial state, authentication status is not yet determined.
*   **`authenticated`**: User is logged in.
*   **`unauthenticated`**: User is not logged in.

### `authProvider`

*   **Type**: `AutoDisposeStreamNotifierProvider<Auth, User?>`
*   **Purpose**: Exposes the current Firebase Authentication user (`User?`) as a stream. It directly reflects changes from `FirebaseAuth.instance.authStateChanges()`.
*   **Class**: `Auth` extends `_$Auth` (generated by Riverpod).
*   **Methods**:
    *   **`signInWithPassword(String email, String password)`**: Attempts to sign in a user. Throws a user-friendly `Exception` on failure (e.g., incorrect credentials, too many requests, network issues).
    *   **`signOut()`**: Signs out the current user and clears Firebase Firestore persistence for a clean state.
    *   **`updatePassword(String newPassword, {String? curPassword})`**: Updates the authenticated user's password. Includes local validation and re-authentication logic if an old password is provided. Updates `dateLastPasswordChange` in the user's profile.
    *   **`updateEmail(String newEmail, {String? curPassword})`**: Updates the authenticated user's email address. Firebase's `verifyBeforeUpdateEmail` is used, meaning the change is finalized only after email verification.
    *   **`reauthenticateUser(String password)`**: Reauthenticates the current user with their password, typically required for sensitive operations.
    *   **`_validatePassword(String pwCandidate)`**: A private helper method for local password validation based on length, letters, digits, and symbols.

### `userProfileProvider`

*   **Type**: `AutoDisposeStreamProvider<UserProfile>`
*   **Purpose**: Provides a stream of the current authenticated user's `UserProfile` object.
*   **Dependencies**: Watches `authProvider` to react to user login/logout events. If no user is authenticated, it returns an error stream.
*   **Data Source**: Fetches the user profile from `UserProfileRepository.getUserProfileStream()` using the current user's UID.

### `userProfileImageProvider`

*   **Type**: `AutoDisposeFutureProvider<ImageProvider?>`
*   **Purpose**: Provides the profile image for the current authenticated user as a `Future<ImageProvider?>`.
*   **Dependencies**: Depends on `userProfileProvider` to obtain the user's UID.
*   **Data Source**: Fetches the image from `UserProfileRepository.fetchUserProfileImage()`.

### `userProfileManagerProvider`

*   **Type**: `AutoDisposeProvider<UserProfileManager>`
*   **Purpose**: Provides an instance of `UserProfileManager`, which encapsulates methods for performing various operations related to the user profile (e.g., writing data, uploading/removing images, deleting account data). It does not hold state itself but facilitates interactions with the `UserProfileRepository`.
*   **Class**: `UserProfileManager`.
*   **Methods**:
    *   **`writeUserProfile(UserProfile userProfile, {bool merge = true})`**: Writes the provided `UserProfile` to the database and invalidates `userProfileProvider` to trigger a UI refresh.
    *   **`uploadNewUserProfileImage(File imageFile)`**: Uploads a new profile image and invalidates `userProfileImageProvider`.
    *   **`removeUserProfileImage()`**: Removes the current profile image and invalidates `userProfileImageProvider`.
    *   **`deleteAccountData()`**: Deletes all user-related data in Firestore and Storage (does not delete the Firebase Auth user itself).
    *   **`ensurePasswordUpToDate()`**: Checks if the user's password has been changed on another device and signs out the current device if it's outdated.